"use strict";angular.module("thirdparties",[]).service("_",["$window",function(a){return a._}]).service("d3",["$window",function(a){return a.d3}]).service("fishtones",["$window",function(a){return a.fishtones}]).service("pviz",["$window",function(a){return a.pviz}]),angular.module("msvizUiApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ui.select","thirdparties","environment","fishtones-wrapper","matches-psms","matches-psms-list","matches-proteins","matches-search","matches-search-results-filter","ssm","sequences","experimental"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("msvizUiApp").controller("MainCtrl",["$scope","$q","_","psmService","ProteinMatch","sequenceService","SearchResultsFilter",function(a,b,c,d,e,f,g){var h=function(){var c=a.searchResultsFilter.getSelectedProtein();b.all([f.get(c.AC,c.source),d.findAllBySearchIdsAndProteinId(a.searchResultsFilter.getSelectedSearchIds(),c.AC)]).then(function(b){a.proteinMatch=new e(b[0],b[1],{targetModification:a.searchResultsFilter.getSelectedModification()})})};a.searchResultsFilter=new g({onComplete:h})}]),angular.module("environment",["angularytics"]).config(["AngularyticsProvider",function(a){a.setEventHandlers(["Console","GoogleUniversal"])}]).service("EnvConfig",["$location","Angularytics",function(a,b){var c=80===a.$$port;return c?{isProd:!0,backendUrl:"http://msviz.vital-it.ch/backend"}:{isProd:!1,backendUrl:"http://localhost:9000"}}]).service("httpProxy",["$http","EnvConfig",function(a,b){var c=function(){return this};return c.prototype.get=function(c,d){return a.get(b.backendUrl+c,d).then(function(a){return a.data})},new c}]).directive("swaggerDoc",["EnvConfig",function(a){return{restrict:"EA",template:'<a href="'+a.backendUrl+'/docs/index.html">backend REST doc</a>'}}]),angular.module("fishtones-wrapper",["thirdparties"]).service("fishtonifyService",["fishtones",function(a){var b=function(){return this};return b.prototype.convertSpectrum=function(b){return new a.wet.ExpMSMSSpectrum({precMoz:b.ref.precursor.moz,precIntensity:b.ref.precursor.intensity,retentionTime:b.ref.precursor.retentionTime,precCharge:b.ref.precursor.charge,scanNumber:b.ref.scanNumber,mozs:b.peaks.mozs,intensities:b.peaks.intensities,intensityRanks:b.peaks.intensityRanks})},new b}]),angular.module("matches-psms",["thirdparties","environment","fishtones-wrapper"]).service("psmService",["$http","EnvConfig","httpProxy",function(a,b,c){var d=function(){return this};return d.prototype.findAllBySearchIdsAndProteinId=function(a,b){var d="/match/psms/"+a.join(",")+"/by-ac/"+b;return c.get(d)},d.prototype.findAllProteinRefsBySearchIds=function(a,b){var d="/match/proteins/"+a.join(",");return b&&(d+="?withModif="+b),c.get(d)},d.prototype.findAllModificationsBySearchIds=function(a){return c.get("/match/modifications/"+a.join(","))},new d}]).service("pvizCustomPsm",["pviz",function(a){a.FeatureDisplayer.trackHeightPerCategoryType.psms=.4,a.FeatureDisplayer.setCustomHandler("psm",{appender:function(a,b,c,d){var e=b.selectAll("g.feature.internal.data."+d).data(c).enter().append("g").attr("class","feature internal data "+d);return e.append("line"),e},positioner:function(a,b){return b.attr("transform",function(b){return"translate(0,"+.4*a.scales.y(.5+b.displayTrack)+")"}),b.selectAll("line").attr("x1",function(b){return a.scales.x(b.start-.4)}).attr("x2",function(b){return a.scales.x(b.end+.4)}),b}}),a.FeatureDisplayer.setCustomHandler("aaInfo",{appender:function(a,b,c,d){var e=b.selectAll("g.feature.internal.data."+d).data(c).enter().append("g").attr("class","feature internal data "+d);return e.append("line").style("stroke-width",function(a){var b=a.data.depth;return 2>=b?b:4>=b?3:4}),e.filter(function(a){return a.data.nbTargetModification}).classed("has-target-modif",!0).append("circle").attr("r",5),e},positioner:function(a,b){return b.attr("transform",function(b){return"translate(0,"+.4*a.scales.y(.5+b.displayTrack)+")"}),b.selectAll("line").attr("x1",function(b){return a.scales.x(b.start-.5)}).attr("x2",function(b){return a.scales.x(b.end+.5)}),b.selectAll("circle").attr("cx",function(b){return a.scales.x(b.start)}),b}})}]).factory("ProteinMatchesGlobalPvizView",["_","pviz","pvizCustomPsm",function(a,b,c){var d=c.yo;d++;var e=function(a,c){var d=this;d.protMatch=c;var e=new b.SeqEntry({sequence:c.getProtein().sequence}),f=new b.SeqEntryAnnotInteractiveView({model:e,el:a});return f.render(),e.addFeatures(d.getFeaturesPSMs()),e.addFeatures(d.getFeaturesAAInfos()),d};return e.prototype.getFeaturesPSMs=function(){var b=this;return a.map(b.protMatch.getMyPSMs(),function(a){return{groupSet:a.searchId,category:"psms",categoryName:"",type:"psm",start:a.proteinList[0].startPos-1,end:a.proteinList[0].endPos-1,data:a}})},e.prototype.getFeaturesAAInfos=function(){var b=this;return a.map(b.protMatch.getAminoAcidInfo(),function(a){return{groupSet:a.searchId,category:"aaInfos",categoryName:"",type:"aaInfo",start:a.pos-1,end:a.pos-1,data:a}})},e}]).directive("matchesPsmPviz",["pviz","ProteinMatchesGlobalPvizView",function(a,b){var c=function(c,d){a.FeatureDisplayer.addMouseoverCallback(["psm"],function(a){c.detailedPSM!==a.data&&(c.detailedPSM=a.data,c.$apply())}),a.FeatureDisplayer.addClickCallback(["psm"],function(a){c.$broadcast("psmAddSelected",a.data)}),c.$watch("proteinMatch",function(a){if(void 0!==a){var c=new b(d,a);return c}})};return{restrict:"E",object:{proteinMatch:"="},link:c,template:'<div style="width:100%; height:400px"></div>'}}]).directive("matchesPsmOneLiner",function(){return{restrict:"E",template:'<div class="psm-one-liner">{{detailedPSM.pep.sequence}} <small>({{detailedPSM.matchInfo.scoreMap["Mascot:score"]}})</small></div>'}}),angular.module("matches-psms-list",["thirdparties","environment","fishtones-wrapper"]).controller("PsmListCtrl",["$scope","$q","_","fishtones","spectrumService","fishtonifyService","ssmService",function(a,b,c,d,e,f,g){a.$on("psmAddSelected",function(b,c){a.addSelectedPSM(c)}),a.selectedMatches=[],a.addSelectedPSM=function(b){c.contains(a.selectedMatches,b)||(b.fishTones={richSeq:(new d.dry.RichSequence).fromString(b.pep.sequence)},c.each(b.pep.modificationNames,function(a,e){c.each(a,function(a){b.fishTones.richSeq.addModification(e-1,d.dry.ResidueModificationDictionary.get(a))})}),b.fishTones.theoMoz=d.dry.MassBuilder.computeMassRichSequence(b.fishTones.richSeq),e.findByRunIdAndId(b.spectrumId.runId,b.spectrumId.id).then(function(c){var d=f.convertSpectrum(c);b.fishTones.spectrum=d,b.type="PSM",a.selectedMatches.push(b)}))},a.getSimSpectra=function(b){g.findSimilarSpectra(b).then(function(c){var d={type:"SSM",ref:b,matches:c};a.selectedMatches.push(d)})},a.removeSelectedPSM=function(b){a.selectedMatches=c.filter(a.selectedMatches,function(a){return a!==b})}}]).directive("matchesPsmListDetails",function(){return{restrict:"E",templateUrl:"views/matches/searches/matchesListDetails.html"}}).factory("MatchesFishtonesPsmSpectrumView",["_","fishtones",function(a,b){var c=function(a,c){var d=this,e=new b.match.PSMAlignment({richSequence:c.richSeq,expSpectrum:c.spectrum}),f=new b.match.MatchSpectrumView({model:e,el:a,tol:1e3,xZoomable:!0});return f.render(),d};return c}]).factory("MatchesFishtonesSSMSpectrumView",["_","fishtones","fishtonifyService",function(a,b,c){var d=function(a,d){var e=this,f=new b.match.SpectraPairAlignment({spectrumA:c.convertSpectrum(d.sp1),spectrumB:c.convertSpectrum(d.sp2)}),g=new b.match.SpectraPairAlignmentView({el:a,model:f,fragTol:50,enhanced:!0});return g.xZoomable(),g.render(),e};return d}]).directive("matchesFishtonesPsmSpectrum",["pviz","MatchesFishtonesPsmSpectrumView",function(a,b){var c=function(a,c){var d=new b(c,a.fishtonespsm);return d};return{link:c,scope:{fishtonespsm:"="},restrict:"A",template:"<div ></div>"}}]).directive("matchesFishtonesSsm",["pviz","MatchesFishtonesSSMSpectrumView",function(a,b){var c=function(a,c){var d=new b(c,a.fishtonesssm);return d};return{link:c,scope:{fishtonesssm:"="},restrict:"A",template:"<div ></div>"}}]),angular.module("ssm",["fishtones-wrapper"]).service("ssmService",["$http","EnvConfig","httpProxy",function(a,b,c){var d=function(){return this};return d.prototype.findSimilarSpectra=function(a){return c.get("/match/sim/"+a.runId+"/"+a.id+"/0.3/0.2")},new d}]),angular.module("matches-search",["thirdparties","environment"]).factory("SearchSet",["_",function(a){var b=function(){var a=this;return a._list={},a};return b.prototype.add=function(b){var c=this;return a.isArray(b)?(a.each(b,function(a){c.add(a)}),c):(c._list[b.searchId]=b,c)},b.prototype.clear=function(){var b=this;return a.each(b.listIds(),function(a){delete b._list[a]}),b},b.prototype.remove=function(a){var b=this;return delete b._list[a.searchId],b},b.prototype.list=function(){return a.values(this._list)},b.prototype.listIds=function(b){var c=a.keys(this._list).sort();return b?c.join(b):c},b.prototype.size=function(){return a.size(this._list)},b}]).service("searchService",["httpProxy",function(a){var b=function(){return this};return b.prototype.list=function(){return a.get("/search")},new b}]),angular.module("matches-proteins",["thirdparties","environment"]).service("proteinMatchesRefService",["httpProxy",function(a){var b=function(){return this};return b.prototype.findBySearchId=function(b){return a.get("/match/proteins/"+b)},new b}]).factory("ProteinMatch",["_",function(a){var b=function(b,c,d){var e=this;return d=a.extend({},d),e._protein=b,e._psms=c,e._targetModification=d.targetModification,e};return b.prototype.getProtein=function(){return this._protein},b.prototype.getPSMs=function(){return this._psms},b.prototype.getTargetModification=function(){return this._targetModification},b.prototype.getMyPSMs=function(){var b=this,c=b.getProtein().proteinRef.identifiers;return a.map(b.getPSMs(),function(b){var d=a.extend({},b);return d.proteinList=a.filter(b.proteinList,function(b){return a.contains(c,b.proteinRef.AC)}),d})},b.prototype.getAminoAcidInfo=function(){var b=this,c={},d=b.getTargetModification();return a.each(b.getMyPSMs(),function(b){var e=function(c){return a.contains(b.pep.modificationNames[c],d)};a.each(b.proteinList,function(f){var g;for(g=f.startPos;g<=f.endPos;g++){var h;if(c[b.searchId]||(c[b.searchId]=[]),h=void 0===c[b.searchId][g]?c[b.searchId][g]={searchId:b.searchId,pos:g,psms:[],depth:0}:c[b.searchId][g],d){var i;i=g===f.startPos?[0,1]:g===f.endPos?[g-f.startPos+1,g-f.startPos+2]:[g-f.startPos+1],a.some(i,e)&&(h.nbTargetModification=h.nbTargetModification?h.nbTargetModification+1:1)}h.psms.push(b),h.depth++}})}),a.chain(c).values().flatten().filter(function(a){return void 0!==a}).value()},b}]),angular.module("sequences",["thirdparties","environment"]).service("sequenceService",["httpProxy",function(a){var b=function(){var a=this;return a};return b.prototype.get=function(b,c){return a.get("/sequence/"+c+"/"+b)},new b}]),angular.module("experimental",["thirdparties","environment"]).service("spectrumService",["$http","EnvConfig","httpProxy",function(a,b,c){var d=function(){return this};return d.prototype.findByRunIdAndId=function(a,b){return c.get("/exp/spectrum/"+a+"/"+b+"?sortByMoz=true&mostIntense=200")},new d}]),angular.module("matches-search-results-filter",["thirdparties","matches-search"]).factory("SearchResultsFilter",["_","SearchSet","searchService","psmService",function(a,b,c,d){var e=function(c){var d=this;return c=a.extend({},c),d.onComplete=c.onComplete,d._selected={searches:new b},d._available={searches:new b},d.init(),d};return e.prototype.init=function(){var a=this;return a._available.searches.clear(),a._available.modifications=void 0,a._available.proteins=void 0,a._selected.modification=void 0,a._selected.protein=void 0,c.list().then(function(b){return a._available.searches.add(b)})},e.prototype.countAvailableSearches=function(){return a.size(this._available.searches.size())},e.prototype.getSelectedSearchIds=function(a){return this._selected.searches.listIds(a)},e.prototype.addSelectedSearch=function(a){var b=this;return b._selected.searches.add(a),b.updateSelectedSearches(),b},e.prototype.removeSelectedSearch=function(a){var b=this;return b._selected.searches.remove(a),b.updateSelectedSearches(),b},e.prototype.updateSelectedSearches=function(){var b=this,c=b.getSelectedSearchIds();return 0===a.size(c)?(delete b._available.modifications,delete b._available.proteins,b):(d.findAllModificationsBySearchIds(c).then(function(c){var d=[{value:void 0,name:"any",count:void 0}];a.each(c,function(a,b){d.push({value:b,name:b,count:a})}),b._available.modifications=d,c[b.getSelectedModification()]||delete b._selected.modification}),b)},e.prototype.setSelectedModification=function(a){var b=this;return b._selected.modification=a,b.updateSelectedModification(),b},e.prototype.getSelectedModification=function(){return this._selected.modification},e.prototype.updateSelectedModification=function(){var b=this;return d.findAllProteinRefsBySearchIds(b.getSelectedSearchIds(),b._selected.modification).then(function(c){b._available.proteins=c,a.find(c,function(c){return a.isEqual(c,b._selected.protein)})||delete b._selected.protein}),b},e.prototype.setSelectedProtein=function(a){var b=this;return b._selected.protein=a,b.updateSelectedProtein(),b},e.prototype.getSelectedProtein=function(){return this._selected.protein},e.prototype.updateSelectedProtein=function(){var a=this;return a.onComplete&&a.onComplete(a),a},e}]).directive("searchResultsFilter",function(){var a=function(){};return{link:a,restrict:"E",scope:{filter:"="},templateUrl:"views/matches/searches/search-results-filter.html"}});