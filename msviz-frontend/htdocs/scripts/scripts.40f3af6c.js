"use strict";angular.module("thirdparties",[]).service("_",["$window",function(a){return a._}]).service("d3",["$window",function(a){return a.d3}]).service("fishtones",["$window",function(a){return a.fishtones}]).service("pviz",["$window",function(a){return a.pviz}]),angular.module("msvizUiApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ui.select","thirdparties","environment","fishtones-wrapper","matches-psms","matches-basket","matches-psms-list","matches-protein","searches-list","matches-modif-filter","multi-searches","psms-alignment","spectrum-tab","sequences","experimental","xic","results-services","results-controller","databases-services","databases-controller","uploads-controller","as.sortable","svg-export","table-expand-service","about-msviz"]).constant("basketLayoutConstants",{padding:30,heigth:150}).config(["$routeProvider",function(a){a.when("/",{redirectTo:"/searches"}).when("/about",{templateUrl:"scripts/main/about-msviz.html",controller:"AboutCtrl"}).when("/searches",{templateUrl:"scripts/main/searches/searches-list.html",controller:"SearchListCtrl"}).when("/results",{templateUrl:"scripts/main/results/results-list.html",controller:"ResultsCtrl"}).when("/databases",{templateUrl:"scripts/main/databases/databases.html",controller:"DatabasesCtrl"}).when("/uploads",{templateUrl:"scripts/main/uploads/uploads.html",controller:"UploadsCtrl"}).when("/result/:searchId",{templateUrl:"scripts/main/results/result.html",controller:"OneResultCtrl"}).when("/proteins/:searchId",{templateUrl:"scripts/main/searches/proteinsID-list.html",controller:"ProteinIDsListCtrl"}).when("/compare/:searchIds",{templateUrl:"scripts/main/compare/searches/multi-searches.html",controller:"MultiSearchListCtrl"}).when("/compare/:searchIds/protein/:proteinAC",{templateUrl:"scripts/main/compare/protein/compare-protein.html",controller:"PsmsAlignmentCtrl"}).when("/details/:searchIds/protein/:proteinAC/spectrumId/:spectrumId/runId/:runId",{templateUrl:"scripts/main/details/spectrum-tab.html",controller:"DetailsTabCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("environment",["angularytics"]).config(["AngularyticsProvider",function(a){a.setEventHandlers(["Console","GoogleUniversal"])}]).service("EnvConfig",["$location","Angularytics",function(a,b){return 9001===a.$$port?{isProd:!1,backendUrl:"http://"+a.$$host+":9000"}:{isProd:!0,backendUrl:a.$$protocol+"://"+a.$$host+"/backend"}}]).service("httpProxy",["$http","EnvConfig",function(a,b){var c=function(){return this};return c.prototype.get=function(c,d){return a.get(b.backendUrl+c,d).then(function(a){return a.data})},c.prototype["delete"]=function(c,d,e){return a["delete"](b.backendUrl+c,d,e).then(function(a){return a})},c.prototype.post=function(c,d,e){return a.post(b.backendUrl+c,d,e).then(function(a){return a})},c.prototype.put=function(c,d,e){return a.put(b.backendUrl+c,d,e).then(function(a){return a})},new c}]).directive("swaggerDoc",["EnvConfig",function(a){return{restrict:"EA",template:'<a href="'+a.backendUrl+'/docs/index.html">backend REST doc</a>'}}]),angular.module("svg-export",[]).service("svgExport",function(){var a=function(){return this};return a.prototype.getSvgString=function(a,b,c){var d=function(a){var b=function(a,b){return a.indexOf(b)!==-1},c=function(a,c){return!!a&&!!_.find(c,function(c){return b(a,c)})},d=[];d.push("#"+a.id);for(var e=0;e<a.classList.length;e++)b("."+a.classList[e],d)||d.push("."+a.classList[e]);for(var f=a.getElementsByTagName("*"),g=0;g<f.length;g++){var h=f[g].id;b("#"+h,d)||d.push("#"+h);for(var i=f[g].classList,j=0;j<i.length;j++)b("."+i[j],d)||d.push("."+i[j])}for(var k="",l=0;l<document.styleSheets.length;l++)for(var m=document.styleSheets[l].cssRules,n=0;n<m.length;n++)c(m[n].selectorText,d)&&(k+=m[n].cssText);return k},e=function(a,b){var c=document.createElement("style");c.setAttribute("type","text/css"),c.innerHTML=a;var d=b.hasChildNodes()?b.children[0]:null;b.insertBefore(c,d)};a.setAttribute("xlink","http://www.w3.org/1999/xlink");var f=d(a);e(f,a);var g=new XMLSerializer,h=g.serializeToString(a);return h=h.replace(/(\w+)?:?xlink=/g,"xmlns:xlink="),h=h.replace(/NS\d+:href/g,"xlink:href"),h=h.replace(/width="[%|\d]+"/,'width="'+b+'"'),h=h.replace(/height="[%|\d]+"/,'height="'+c+'"')},a.prototype.svgString2Png=function(a,b,c,d){var e="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(a))),f=document.createElement("canvas"),g=f.getContext("2d");f.width=b,f.height=c;var h=new Image;h.onload=function(){g.clearRect(0,0,b,c),g.drawImage(h,0,0,b,c),f.toBlob(function(a){var b=Math.round(a.length/1024)+" KB";d&&d(a,b)})},h.src=e},new a}),angular.module("fishtones-wrapper",["thirdparties"]).service("fishtonifyService",["_","fishtones",function(a,b){var c=function(){return this.richSeqShortcuter=new b.dry.RichSequenceShortcuter,this};return c.prototype.convertSpectrum=function(a,c){return new b.wet.ExpMSMSSpectrum({precMoz:c,precIntensity:a.ref.precursor.intensity,retentionTime:a.ref.precursor.retentionTime,precCharge:a.ref.precursor.charge,scanNumber:a.ref.scanNumber,mozs:a.peaks.mozs,intensities:a.peaks.intensities,intensityRanks:a.peaks.intensityRanks})},c.prototype.buildRichSeq=function(c){var d=this,e=(new b.dry.RichSequence).fromString(c.pep.sequence);return a.each(c.pep.modificationNames,function(c,d){a.each(c,function(a){e.addModification(d-1,b.dry.ResidueModificationDictionary.get(a))})}),{richSeq:e,richSeqShortcut:d.richSeqShortcuter.richSeqToString(e)}},new c}]),angular.module("matches-psms",["protein-matches-pviz-view","psm-service","thirdparties","environment","fishtones-wrapper","matches-protein","table-expand-service"]).directive("matchesPsmPviz",["pviz","ProteinMatchesGlobalPvizView","fishtones","fishtonifyService","spectrumService","psmConvertionService",function(a,b,c,d,e,f){var g=function(a,b){b.fishTones=d.buildRichSeq(b),b.fishTones.theoMoz=c.dry.MassBuilder.computeMassRichSequence(b.fishTones.richSeq),e.findSpByRunIdAndId(b.searchId,b.spectrumId.id).then(function(c){var e=b.matchInfo.correctedMoz?b.matchInfo.correctedMoz:c.ref.precursor.moz,f=d.convertSpectrum(c,e);b.fishTones.spectrum=f,a.$broadcast("basket-add",{type:"psm",bean:b})})},h=function(c,d){a.FeatureDisplayer.setMousemovementCallback(function(a){c.coordinates=a}),a.FeatureDisplayer.addMouseoverCallback(["psm"],function(a){var b=f.posScoreFromMatchInfo(a.data.matchInfo,1);a.data.matchInfo.posScore=b,c.$broadcast("show-match",{type:"psm",bean:a.data})}),a.FeatureDisplayer.addMouseoutCallback(["psm"],function(){c.$broadcast("hide-match",void 0)}),a.FeatureDisplayer.addClickCallback(["psm"],function(a){g(c,a.data),c.pvizView.addSelPsm(a.data),c.pvizView.refreshView()}),c.$on("psm-selected",function(a,b){c.pvizView.addSelPsm(b),c.pvizView.refreshView()}),c.$watch("proteinMatch",function(a){if(void 0!==a){var e=new b(d,a,c.searchIds);return c.pvizView=e,e}}),a.FeatureDisplayer.addClickCallback(["aaInfo"],function(a){c.$broadcast("show-ptm-matches",{pos:a.data.pos})}),a.FeatureDisplayer.addClickCallback(["aaModif"],function(a){c.$broadcast("show-ptm-matches",{pos:a.start+1})}),a.FeatureDisplayer.addClickCallback(["ptmCount"],function(a){c.$broadcast("show-ptm-matches",{pos:a.data.pos})}),c.$on("show-ptm-matches",function(a,b){c.pvizView.setSelPsmPos(b.pos),c.pvizView.refreshView()}),c.$on("basket-remove",function(a,b){c.pvizView.removeSelPsm(b),c.pvizView.refreshView()})};return{restrict:"E",object:{proteinMatch:"="},link:h,template:'<div style="width:100%; height:400px"></div>'}}]).controller("MatchesPSMCtrl",["$scope","_","psmService","TableExpandedService",function(a,b,c,d){a.loadPSMSForSpectrum=function(){c.findAllBySearchIdAndSpectrumId(a.psm.searchId,a.psm.spectrumId.id).then(function(b){b.length>1&&(a.psm4spectrum=b)})},a.loadPSMSForSpectrum(),a.expandOtherMatchTable=function(b){var c=!a.tableExpanded;d.setStatus(b,c),a.tableExpanded=c}}]).directive("matchesPsmBox",function(){return{restrict:"E",scope:{psm:"=",itemid:"="},templateUrl:"scripts/main/compare/protein/basket/matches-psm-box.html"}}).controller("detailedMatchCtrl",["$scope",function(a){angular.element("#detailInfoPopover").popover(),a.$on("show-match",function(b,c){var d=a.coordinates[0],e=a.coordinates[1];angular.element("#detailInfoPopover").show(),angular.element("#detailInfoPopover").css("left",d+30+"px"),angular.element("#detailInfoPopover").css("top",e-10+"px"),delete a.psm,delete a.psmIsoModif,a[c.type]=c.bean,a.$apply()}),a.$on("hide-match",function(){angular.element("#detailInfoPopover").hide()})}]).directive("matchesOneLiner",function(){return{restrict:"E",templateUrl:"scripts/main/compare/protein/alignment/matches-one-liner.html"}}),angular.module("matches-psms-list",["thirdparties","environment","fishtones-wrapper"]).factory("MatchesFishtonesPsmSpectrumView",["basketLayoutConstants","_","fishtones",function(a,b,c){var d=function(b,d){var e=this,f=new c.match.PSMAlignment({richSequence:d.richSeq?d.richSeq:(new c.dry.RichSequence).fromString(""),expSpectrum:d.spectrum,annotatePhospho:d.richSeq?(d.richSeq.toString().match(/Phospho/g)||[]).length:void 0}),g=new c.match.MatchSpectrumView({model:f,el:b,tol:d.fragmentTolerance||500,tolUnity:d.fragmentToleranceUnit||"ppm",xZoomable:!0});g.render(),e.spView=g;var h=a.padding,i=a.heigth,j=document.getElementById("basket-container").offsetWidth,k=document.getElementsByClassName("fishtones-sp"),l=0;l=k.length>0?k[0].offsetWidth:j/2-h;var m={height:i,width:l>0?l:100};return g.resize(m),e};return d}]).directive("matchesFishtonesPsmSpectrum",["pviz","_","MatchesFishtonesPsmSpectrumView",function(a,b,c){var d=function(a,d){var e=new c(d,a.fishtonespsm),f=a.$parent.selectedItemsId;if(a.$parent.$parent.selectedItems){var g=b.findWhere(a.$parent.$parent.selectedItems,{id:f});g.spView=e.spView}return e};return{link:d,scope:{fishtonespsm:"="},restrict:"A",template:"<div></div>"}}]),angular.module("matches-basket",["toaster","thirdparties","environment","searches-list"]).controller("MatchesBasketCtrl",["toaster","basketLayoutConstants","$scope","$q","_","$location","$routeParams","httpProxy","svgExport","d3","searchService",function(a,b,c,d,e,f,g,h,i,j,k){c.showAddedLabel=!1,c.searchIds=g.searchIds.split(",");var l=g.proteinAC.split(":");c.proteinAC=l[0],c.selectedItems=[],c.runAndSpUniqueIds=[],c.selectedItemsId=-1,c.viewSizeLeft=6,c.viewSizeRight=6,c.$on("resize-view",function(){c.selectedItems.forEach(function(a){m(a.spView,a.xicView)})});var m=function(a,d){var e=b.padding,f=b.heigth,g=document.getElementById("basket-container").offsetWidth,h=6===c.viewSizeLeft?g/2-e:g-e,i={height:f,width:h>0?h:100};c.viewSizeLeft&&a&&a.resize(i),c.viewSizeRight&&d&&d.resize(i)};c.zoomSp=function(){c.viewSizeRight=c.viewSizeLeft?0:6,c.viewSizeLeft=c.viewSizeLeft?12:6,c.selectedItems.forEach(function(a){m(a.spView,a.xicView)})},c.zoomXic=function(){c.viewSizeLeft=c.viewSizeRight?0:6,c.viewSizeRight=c.viewSizeRight?12:6,c.selectedItems.forEach(function(a){m(a.spView,a.xicView)})},c.exportSvg=function(a,b,c){var d=a.id,e=a.ms2Info.precMoz.toFixed(2),f=a.ms2Info.xicTolerance.toFixed(2),g=a.ms2Info.scanNr,h=b+"-"+("xic"===b?e+"-"+f:g),k=j.select("#"+b+"_"+d)[0][0],l="xic"===b?k.childNodes[0]:k.childNodes[1],m=l.getBBox().height,n=l.getBoundingClientRect().width,o=i.getSvgString(l,n,m);if("png"===c){var p=function(a){saveAs(a,h+".png")};i.svgString2Png(o,n,m,p)}else{var q=new Blob([o],{type:"image/svg+xml;charset=utf-8"});saveAs(q,h+".svg")}},c.$on("basket-add",function(a,b){if("xic"===b.type)c.addManualXic(b);else{var d=b.bean.spectrumId.runId+b.bean.spectrumId.id;e.find(c.runAndSpUniqueIds,function(a){return a===d})||(c.runAndSpUniqueIds.push(d),c.addSelected(b))}}),c.addManualXic=function(a){c.selectedItemsId++;var b={id:c.selectedItemsId,type:a.type,firstPsm:null,otherPsms:[],ms2Info:{precMoz:a.moz,xicTolerance:a.xicTolerance}};c.selectedItems.push(b)},c.addSelected=function(a){c.selectedItemsId++;var b,d=a.bean.fishTones?a.bean.fishTones.spectrum.attributes:a.bean.spectrum.attributes,e={precCharge:d.precCharge,precIntensity:d.precIntensity,precMoz:d.precMoz,xicTolerance:10,retentionTime:d.retentionTime,searchId:a.bean.spectrumId.runId,scanNr:a.bean.spectrumId.id};"psm"===a.type?(b={id:c.selectedItemsId,type:a.type,firstPsm:a.bean,otherPsms:[],ms2Info:e},k.get(b.firstPsm.searchId).then(function(a){var c=a.fragmentTolerance.split(/\s+/);switch(b.firstPsm.fishTones.fragmentTolerance=c[0],c[1].charAt(0).toLowerCase()){case"p":b.firstPsm.fishTones.fragmentToleranceUnit="ppm";break;case"d":b.firstPsm.fishTones.fragmentToleranceUnit="dalton";break;default:b.firstPsm.fishTones.fragmentToleranceUnit=void 0}})):b={id:c.selectedItemsId,type:a.type,fishTones:{spectrum:a.bean.spectrum},ms2Info:e},c.selectedItems.push(b)},c.addToResults=function(a){var b=e.map(a.xicPeaks,function(a){return{searchId:a.searchId,rt:Number(a.rt),intensity:Number(a["int"])}}),d=c.searchIds.concat().sort(),f=e.sortBy(b,function(a){return a.searchId}),g={proteinAC:a.firstPsm.proteinList[0].proteinRef.AC,peptideSeq:a.firstPsm.fishTones.richSeq.toString(),startPos:a.firstPsm.proteinList[0].startPos,endPos:a.firstPsm.proteinList[0].endPos,searchIds:d.join(","),spectrumId:a.firstPsm.spectrumId,score:a.firstPsm.matchInfo.score.mainScore,localizationScore:a.firstPsm.matchInfo.score.scoreMap["Mascot:delta score"],ppmTolerance:10,rtZoom:{lowerRt:10,upperRt:30},rtSelected:{lowerRt:10,upperRt:30},xicPeaks:f,nextAA:a.firstPsm.nxtAA,prevAA:a.firstPsm.prevAA,ppmDiff:a.firstPsm.ppmDiff};h.put("/basket",g,{headers:{"Content-Type":void 0}}).then(function(){a.showAddedLabel=!0}),setTimeout(function(){c.$apply(function(){a.showAddedLabel=!1})},2e3)},c.zoomSpectrum=function(a,b){var d="/#/details/"+c.searchIds+"/protein/"+c.proteinAC+"/spectrumId/"+b+"/runId/"+a;window.open(d,"_blank")},c.resetSpectrum=function(a,b){b[a].model.reset()},c.resetXic=function(a,b){b[a].model.reset()},c.zoomAllOther=function(a,b){var d=e.findWhere(c.selectedItems,{id:a})[b],f=d.scalingContext._xDomain;c.selectedItems.forEach(function(c){c.id!==a&&(c[b].zoomX?c[b].zoomX(f):c[b].scalingContext.xDomain(f))})};var n=function(a){var b={searchId:a.ms2Info.searchId,spNr:a.ms2Info.scanNr};c.$emit("basket-remove",b)},o=function(a){c.selectedItems=e.filter(c.selectedItems,function(b){return b.id!==a.id})},p=function(a){var b=a.ms2Info.searchId+a.ms2Info.scanNr;c.runAndSpUniqueIds=e.filter(c.runAndSpUniqueIds,function(a){return a!==b})};c.removeSelectedItem=function(a){switch(a.type){case"psm":o(a),p(a),n(a);break;case"xic":o(a);break;case"sp":o(a),p(a)}}}]).directive("matchesBasketDetailsAll",function(){return{restrict:"E",templateUrl:"scripts/main/compare/protein/basket/detailed-all.html"}}).directive("xicButtonDirective",["$templateCache",function(a){return function(b,c){c.popover({html:!0,trigger:"hover",placement:"left",content:function(){return a.get("xicPopoverTemplate.html")}})}}]).directive("spButtonDirective",["$templateCache",function(a){return function(b,c){c.popover({html:!0,trigger:"hover",placement:"right",content:function(){return a.get("spPopoverTemplate.html")}})}}]),angular.module("matches-psm-iso-modif",["thirdparties"]).factory("PSMIsoModif",["_",function(a){var b=function(a){var b=this;return b._psms=a.psms,b._fixModif=a.fixModif,b._varModif=a.varModif,b._description=a.description,b};return b.prototype.getPSMs=function(){return this._psms},b.prototype.getFixModif=function(){return this._fixModif},b.prototype.getVarModif=function(){return this._varModif},b.prototype.getDescription=function(){var b=this;if(void 0===b._description){var c=b._psms[0].pep.sequence+" x"+b.countPSM();a.size(b._fixModif)&&(c+=" fixed:"+a.map(b._fixModif,function(a,b){return b+"@("+a.pos.join("/")+")"}).join(", ")),a.size(b._varModif)&&(c+=" variables:"+a.map(b._varModif,function(a,b){return b+" "+a.count+"@("+a.pos.join("/")+")"}).join(", ")),b._description=c}return b._description},b.prototype.countPSM=function(){return this._psms.length},b.prototype.getProteinList=function(){return this._psms[0].proteinList},b.prototype.hasUniquePSM=function(){return 1===this._psms.length},b}]).service("psmIsoModifBuilder",["_","PSMIsoModif",function(a,b){var c=function(){};return c.prototype._projectModif=function(b){var c=a.chain(b.pep.modificationNames).map(function(b,c){return a.map(b,function(a){return{modif:a,pos:c}})}).flatten().value();return c},c.prototype.buildList=function(b){var c=this;return a.chain(b).groupBy(function(b){return b.pep.sequence+":"+a.chain(c._projectModif(b)).groupBy("modif").map(function(a,b){return{modif:b,count:a.length}}).sortBy("modif").map(function(a){return a.modif+":"+a.count}).value().join(";")}).map(function(a){return c.buildOnePSMIsoModif(a)}).value()},c.prototype.buildOnePSMIsoModif=function(c){var d={},e=c[0].pep.sequence.length+2;a.each(c,function(b){a.each(b.pep.modificationNames,function(b,c){a.each(b,function(b){void 0===d[b]&&(d[b]=[],a.times(e,function(a){d[b][a]=0})),void 0===d[b][c]?d[b][c]=1:d[b][c]++})})});var f=a.size(c),g={},h={};return a.each(d,function(b,c){var d=[],e=[],i=0;a.each(b,function(a,b){if(0!==a){if(a===f)return void e.push(b-1);i+=a,d.push(b-1)}}),a.size(e)>0&&(g[c]={pos:e}),a.size(d)>0&&(h[c]={pos:d,count:i/f})}),new b({psms:c,fixModif:g,varModif:h})},new c}]),angular.module("searches-list",["toaster","thirdparties","environment"]).service("searchService",["httpProxy",function(a){var b=function(){return this};return b.prototype.list=function(){return a.get("/search")},b.prototype.deleteMatchInfo=function(b){return a["delete"]("/search/"+b)},b.prototype.deleteSpectra=function(b){return a["delete"]("/exp/msrun/"+b)},b.prototype.get=function(b){return a.get("/search/"+b)},new b}]).controller("SearchListCtrl",["toaster","$scope","searchService","$location","_",function(a,b,c,d,e){b.refreshSearches=function(){b.ids=[],b.selectedIds=[],b.searchIds="",b.titles="",b.getSearchList()},b.formatSearchIdError=function(a){var b=a.replace(/^(\d+\_)/,"");return b},b.deleteOneSearchId=function(a){c.deleteMatchInfo(a).then(function(){b.getSearchList()})},b.getSearchList=function(){var d=a.pop("wait","Loading searches","",0);c.list().then(function(c){b.searches=e.sortBy(c,"creationDate").reverse(),a.clear(d)})},b.setUploadModal=function(a){b.selStatus=a,$("#uploadModal").modal("show")},b.getSearchList(),b.ids=[],b.selectedIds=[],b.searchIds="",b.titles="",b.addId=function(a){b.ids.push(a)},b.updateId=function(a){var c=b.selectedIds.indexOf(a);c>-1?b.selectedIds.splice(c,1):b.selectedIds.push(a)},b.getSearchIds=function(){var a=[];b.selectedIds.forEach(function(c){var d=b.searches[c];a.push({id:d.searchId,title:d.title})});var c=e.sortBy(a,function(a){return a.id}).reverse();b.searchIds=e.pluck(c,"id").join(","),b.titles=e.pluck(c,"title").join(",");var d="#/compare/".concat(b.searchIds).concat("?param="+b.titles);window.open(d,"_blank")},b.deleteSearchIds=function(){b.showDeletionAlert=!0;var a=[];b.selectedIds.forEach(function(c){var d=b.searches[c];a.push(d.searchId)});var d=a.join(",");c.deleteSpectra(a).then(function(){console.log("spectra deleted"),c.deleteMatchInfo(d).then(function(){console.log("match info deleted"),b.getSearchList(),b.ids=[],b.selectedIds=[],b.searchIds="",b.titles="",b.showDeletionAlert=!1,b.showDeletionFinished=!0})})}}]),angular.module("matches-protein",["thirdparties","environment","matches-psm-iso-modif"]).service("psmConvertionService",function(){var a=function(){return this};return a.prototype.posScoreFromMatchInfo=function(a,b){var c=a.score.scoreMap["Mascot:delta score"],d=c?parseFloat(c).toFixed(b):void 0;if(d)d+="%";else{var e=a.highestModifProbability;e&&(d=_.reduce(e,function(a,c,d){return a.push(d.substring(0,2)+":"+parseFloat(c).toFixed(b)),a},[]).join(";"))}return d},new a}).service("proteinMatchesRefService",["httpProxy",function(a){var b=function(){return this};return b.prototype.findBySearchId=function(b){return a.get("/match/protein-matches/"+b)},new b}]).controller("ProteinIDsListCtrl",["$scope","$routeParams","proteinMatchesRefService",function(a,b,c){a.searchId=b.searchId,c.findBySearchId(a.searchId).then(function(b){a.proteins=b})}]).factory("ProteinMatch",["_","psmIsoModifBuilder",function(a,b){var c=function(b,c,d){var e=this;return d=a.extend({},d),e._protein=b,e._psms=c,e._targetModification=d.targetModification,e};return c.prototype.getProtein=function(){return this._protein},c.prototype.getPSMs=function(){return this._psms},c.prototype.getTargetModification=function(){return this._targetModification},c.prototype.setTargetModification=function(a){this._targetModification=a},c.prototype.getMyBestPSMs=function(){var b=this,c=b.getProtein().proteinRef.identifiers,d=a.map(b.getPSMs(),function(b){var d=a.extend({},b);return d.proteinList=a.filter(b.proteinList,function(b){return a.contains(c,b.proteinRef.AC)}),d});return a.filter(d,function(a){return 1===a.matchInfo.rank})},c.prototype.getMyPSMs=function(){var b=this,c=b.getProtein().proteinRef.identifiers;return a.map(b.getPSMs(),function(b){var d=a.extend({},b);return d.proteinList=a.filter(b.proteinList,function(b){return a.contains(c,b.proteinRef.AC)}),d})},c.prototype.getMyPSMIsoModif=function(){var a=this;return b.buildList(a.getMyPSMs())},c.prototype.getAminoAcidInfo=function(){var b=this,c={},d=b.getTargetModification(),e=b.getProtein().sequence.split("");return a.each(b.getMyBestPSMs(),function(b){var f=function(c){return a.contains(b.pep.modificationNames[c],d)};a.each(b.proteinList,function(g){var h;for(h=g.startPos;h<=g.endPos;h++){var i;if(c[b.searchId]||(c[b.searchId]=[]),i=void 0===c[b.searchId][h]?c[b.searchId][h]={searchId:b.searchId,aa:e[h-1],pos:h,psms:[],depth:0}:c[b.searchId][h],d){var j;j=h===g.startPos?[0,1]:h===g.endPos?[h-g.startPos+1,h-g.startPos+2]:[h-g.startPos+1],a.some(j,f)&&(i.nbTargetModification=i.nbTargetModification?i.nbTargetModification+1:1)}i.psms.push(b),i.depth++}})}),a.chain(c).values().flatten().filter(function(a){return void 0!==a}).value()},c.prototype.getTargetAminoAcidWithTargetModif=function(){var b=this;return a.filter(b.getAminoAcidInfo(),function(a){return a.nbTargetModification})},c}]),angular.module("multi-searches",["thirdparties","environment","matches-modif-filter","as.sortable"]).service("multiSearchService",["httpProxy",function(a){var b=function(){return this};return b.prototype.findByMultiSearchId=function(b,c){return a.get("/compare/"+b+c)},b.prototype.prepareAmountProteins=function(a){var b={},c=Object.keys(a);return c.forEach(function(c){var d=Object.keys(a[c]);d.forEach(function(a){b.hasOwnProperty(a)?b[a]=b[a]+1:b[a]=1})}),b},b.prototype.prepareInfoMap=function(a,b){var c=this,d=Object.keys(a),e=[];return d.forEach(function(d){var f=c.getProteinIdents.apply(void 0,[a,d,b]),g=0,h={},i=!1;f.protIdents.forEach(function(a){a&&(g+=a.mainProt.score.mainScore,h[a.searchId]=a.mainProt.source,i=!(!a.mainProt.isContaminant||a.mainProt.isContaminant!==!0)||(i||!1))});var j=Object.values(h)[0],k={ac:d,source:h,mainSource:j,score:g,datatable:f.datatable,isContaminant:i};e.push(k)}),e},b.prototype.prepareProteinInfos=function(a,b){var c=this,d={};return d.amountProteinHash=c.prepareAmountProteins(a),d.proteinInfos=c.prepareInfoMap(a,b),d},b.prototype.getProteinIdents=function(a,b,c){var d={},e=a[b],f=[],g=[],h=[],i=[];return c.forEach(function(a){e[a]?(f.push(e[a]),g.push(e[a].mainProt.score.mainScore.toFixed(0)),h.push(e[a].mainProt.nrPsms),i.push(e[a].mainProt.nrSequences)):(f.push(null),g.push(null),h.push(null),i.push(null))}),d.datatable=g.concat(h,i),d.protIdents=f,d},new b}]).controller("MultiSearchListCtrl",["$scope","$routeParams","$location","multiSearchService","ModifFilter","_",function(a,b,c,d,e,f){a.searchIds=b.searchIds.split(","),a.titles=c.search().param.split(","),a.searchIdList=a.searchIds,a.listSearchInfo=[];var g={};a.dragControlListeners={orderChanged:function(){a.searchIdList=f.pluck(a.listSearchInfo,"searchId")}};for(var h=0;h<a.searchIds.length;h++)g={searchId:a.searchIds[h],title:a.titles[h],index:h+1},a.listSearchInfo.push(g);d.findByMultiSearchId(a.searchIds,"").then(function(b){a.proteins=d.prepareProteinInfos(b,a.searchIds)});var i=function(){var c=void 0!==a.modifFilter.getSelectedModification()?"?withModif="+a.modifFilter.getSelectedModification():"";d.findByMultiSearchId(b.searchIds,c).then(function(b){a.proteins=d.prepareProteinInfos(b,a.searchIds)})};a.modifFilter=new e({onComplete:i,searchIds:a.searchIds})}]),angular.module("psms-alignment",["toaster","matches-modif-filter","matches-protein","sequences","matches-psms","thirdparties","environment","svg-export"]).controller("PsmsAlignmentCtrl",["toaster","$scope","$routeParams","$q","psmService","sequenceService","ProteinMatch","ModifFilter","d3","svgExport","$templateCache",function(a,b,c,d,e,f,g,h,i,j,k){b.removePvizPopover=function(){b.$broadcast("hide-match")},angular.element("#pviz-info-button").popover({html:!0,trigger:"hover",placement:"left",content:function(){return k.get("pvizPopoverTemplate.html")}}),b.stopPropagation=function(a){a.stopPropagation()},b.xicTolerance=10,b.viewSizeLeft=6,b.viewSizeRight=6,b.zoomPviz=function(){b.viewSizeRight=b.viewSizeLeft?0:6,b.viewSizeLeft=b.viewSizeLeft?12:6,setTimeout(function(){b.$broadcast("resize-view"),b.pvizView.view.resize()},100)},b.zoomBasket=function(){b.viewSizeLeft=b.viewSizeRight?0:6,b.viewSizeRight=b.viewSizeRight?12:6,setTimeout(function(){b.$broadcast("resize-view"),b.pvizView.view.resize()},100)},b.extractXic=function(){b.extractXicMoz&&b.$broadcast("basket-add",{type:"xic",moz:parseFloat(b.extractXicMoz),xicTolerance:b.xicTolerance})},b.exportSvg=function(c){var d=a.pop("wait","Preparing image","",0);setTimeout(function(){var e=i.select(".pviz")[0][0],f=e.getBBox().height,g=e.getBoundingClientRect().width,h=j.getSvgString(e,g,f),k="protein-coverage-"+b.proteinAC;if("png"===c){var l=function(a){saveAs(a,k+".png")};j.svgString2Png(h,g,f,l)}else{var m=new Blob([h],{type:"image/svg+xml;charset=utf-8"});saveAs(m,k+".svg")}a.clear(d)})},b.mouseoverPvizInfo=function(){angular.element("#pvizInfoPopover").show()},b.mouseoutPvizPopover=function(){angular.element("#pvizInfoPopover").hide()},b.searchIds=c.searchIds.split(",");var l=c.proteinAC.split("::");b.proteinAC=l[0],b.database=l[1],b.$on("show-xic-emit",function(a,c){b.$broadcast("show-xic-broadcast",c)});var m=function(a){var b={};_.each(a,function(a){if(!a.matchInfo.isRejected&&1===a.matchInfo.rank){var c=_.filter(a.pep.modificationNames,function(a){return a.length>0});_.each(c,function(a){b[a[0]]=b[a[0]]?b[a[0]]+1:1})}});var c=_.map(b,function(a,b){return{name:b,value:b,count:a}});return[{name:"None",value:void 0,count:void 0}].concat(c)},n=function(){setTimeout(function(){b.toast=a.pop("wait","Loading "+b.proteinAC,"",0)},10),f.getSource(b.searchIds,b.database).then(function(c){d.all([f.get(b.proteinAC,c),e.findAllBySearchIdsAndProteinId(b.searchIds,b.proteinAC)]).then(function(c){a.clear(b.toast);var d=m(c[1]);b.modifFilter.setModifList(d),b.proteinMatch=new g(c[0],c[1],{targetModification:b.modifFilter.getSelectedModification()})},function(){a.clear(b.toast),b.proteinNotFound=b.proteinAC,b.dbNotFound=c})})};b.modifFilter=new h({onComplete:n,searchIds:b.searchIds}),n()}]),angular.module("sequences",["thirdparties","environment"]).service("sequenceService",["httpProxy","$q",function(a,b){var c=function(){var a=this;return a};return c.prototype.get=function(b,c){return a.get("/sequence/"+c+"/"+b)},c.prototype.getSource=function(c,d){var e=_.map(c,function(b){return a.get("/search/"+b)});return b.all(e).then(function(a){var b=_.map(a,function(a){var b=a.database;return b.filter(function(a){return a.id===d})}),c=_.find(b,function(a){return a.length>0}),e=c[0].version?c[0].version:d;return e})},new c}]),angular.module("experimental",["thirdparties","environment"]).service("spectrumService",["$http","EnvConfig","httpProxy",function(a,b,c){var d=function(){return this};return d.prototype.findSpByRunIdAndId=function(a,b){return c.get("/exp/spectrum/"+a+"/"+b+"?sortByMoz=true&mostIntense=200")},d.prototype.findSpRefByRunIdAndId=function(a,b){return c.get("/exp/spectrum-ref/"+a+"/"+b)},new d}]),angular.module("table-expand-service",["thirdparties","environment"]).factory("TableExpandedService",["_",function(a){var b=[];return{notifyOnChange:function(a,c){b.push({itemId:a,callback:c})},setStatus:function(c,d){var e=a.find(b,function(a){return a.itemId===c});e?e.callback(d):console.log("Warning: no callback for id ["+c+"] in table-expand-service")}}}]),angular.module("matches-modif-filter",["thirdparties","searches-list"]).factory("ModifFilter",["_","psmService",function(a,b){var c=function(b){var c=this;return b=a.extend({},b),c.onComplete=b.onComplete,c._searchIds=b.searchIds,c._searchIds&&c.init(),c};return c.prototype.init=function(){var c=this;return c._availableModifications=void 0,c._selectedModification=void 0,b.findAllModificationsBySearchIds(c._searchIds).then(function(b){var d=[{value:void 0,name:"None",count:void 0}];a.each(b,function(a,b){d.push({value:b,name:b,count:a})}),c._availableModifications=d})},c.prototype.setModifList=function(a){var b=this;b._availableModifications=a},c.prototype.setSelectedModification=function(a){var c=this;return c._selectedModification=a,b.findAllProteinRefsBySearchIds(c._searchIds,c._selectedModification).then(function(){c.onComplete(c)}),c},c.prototype.getSelectedModification=function(){return this._selectedModification},c}]).directive("modifFilter",function(){var a=function(){};return{link:a,restrict:"E",scope:{filter:"="},templateUrl:"scripts/main/compare/protein/modif-filter.html"}}),angular.module("protein-matches-pviz-view",["pviz-custom-psm","thirdparties","environment","fishtones-wrapper","experimental"]).factory("ProteinMatchesGlobalPvizView",["_","pviz","pvizCustomPsm","spectrumService",function(a,b,c,d){var e=c.yo;e++;var f=function(a,c,d){var e=this;e.selPsms=[],e.protMatch=c;var f=new b.SeqEntry({sequence:c.getProtein().sequence}),g=new b.SeqEntryAnnotInteractiveView({model:f,el:a,groupSetOrder:[void 0].concat(d)});return g.render(),e.seqEntry=f,e._showAllPsm=!1,e.view=g,e.refreshView(),e};f.prototype.refreshView=function(){var a=this;a.seqEntry.clear(),a.seqEntry.addFeatures(a.getFeaturesAATargetModif()),a.seqEntry.addFeatures(a.getFeaturesPTMsCount()),a.seqEntry.addFeatures(a.getFeaturesAAInfos()),a.seqEntry.addFeatures(a.getFeaturesPSMs())};var g=function(b,c){var d=b[0],e=d.proteinList[0];h(d);var f=[];return a.each(d.matchInfo.modificationInfos,function(b,d){var g,h=d===c?a.sortBy(b,function(a){return-a.modifProb}):b,i=a.map(h,function(a){var b="",f=!1;d===c&&(f=!0,"MAIN"===a.status?(g=a.modifProb,b="first"):g-a.modifProb<.1&&(b="firstWithConflict"));var h=e.endPos-e.startPos+1,i=Math.max(-.3,a.position-1);i=Math.min(h-.7,i);var j=i+e.startPos-1;return{pos:j,modifNames:d,text:d,modifRank:b,selectedModif:f}});f=f.concat(i)}),{groupSet:d.searchId,category:"psms",categoryName:"",type:"psm",start:e.startPos-1,end:e.endPos-1,data:d,modif:f}},h=function(b){d.findSpRefByRunIdAndId(b.searchId,b.spectrumId.id).then(function(c){var d=b.matchInfo.correctedMoz?b.matchInfo.correctedMoz:c.precursor.moz,e="scan: "+c.scanNumber+" ("+(c.precursor.retentionTime/60).toFixed(1)+"min) m/z: "+d.toFixed(4)+" ("+c.precursor.charge+"+)  massDiff: "+b.ppmDiff.toFixed(2)+" ppm";b.spTitle=e,b.prevAA=a.first(b.proteinList).previousAA.toString(),b.nxtAA=a.first(b.proteinList).nextAA.toString()})},i=function(b,c){var d=a.sortBy(b,function(a){return a.matchInfo.rank}),e=d[0],f=e.proteinList[0];h(e);var g=a.countBy(d,function(a){return a.matchInfo.score.mainScore}),i=a.max(a.map(g,function(a,b){return parseFloat(b)})),j=[];return a.each(d,function(b){var d=b.proteinList[0],e=d.endPos-d.startPos+1;a.each(b.pep.modificationNames,function(f,g){if(0!==a.size(f)){var h=Math.max(-.3,g-1);h=Math.min(e-.7,h);var k="",l=f[0]===c;if(f.length>1&&console.log("protein-matches-pviz-view - l121 :  mods is bigger than 1 => "+f.length),b.matchInfo.score.mainScore===i)k=1===b.matchInfo.rank?"first":"firstWithConflict";else if(!l)return;
var m=h+d.startPos-1;a.findWhere(j,{pos:m})||j.push({pos:m,modifNames:f,text:f.join(","),modifRank:k,selectedModif:l})}})}),{groupSet:e.searchId,category:"psms",categoryName:"",type:"psm",start:f.startPos-1,end:f.endPos-1,data:e,modif:j}};return f.prototype.getFeaturesPSMs=function(){var b=this,c=b.protMatch.getTargetModification(),d=b._selPsmPos,e=b.protMatch.getMyPSMs(),f=a.filter(e,function(a){var b=a.proteinList[0];return d<=b.endPos&&d>=b.startPos}),h=a.groupBy(f,function(a){return a.spectrumId.id+a.spectrumId.runId}),j=a.chain(h).map(function(a){var b;return b=1===a.length&&a[0].matchInfo.modificationProbabilities?g(a,c):i(a,c)}).filter(Boolean).map(function(c){var d=a.find(b.selPsms,function(a){return a.searchId===c.data.searchId&&a.spNr===c.data.spectrumId.id});return c.isSelected=void 0!==d,c}).flatten().value();return j},f.prototype.getFeaturesPSMIsoModifs=function(){var b=this,c=b.protMatch.getTargetModification(),d=a.chain(b.protMatch.getMyPSMIsoModif()).map(function(b){return a.map(b.getProteinList(),function(d){var e=[],f=d.endPos-d.startPos+1,g=function(a){var b=Math.max(-.3,a);return b=Math.min(f-.7,b),b-1};return a.each(b.getFixModif(),function(b,f){a.each(b.pos,function(a){e.push({pos:g(a)+d.startPos,modifName:f,text:f,isTarget:f===c,isFix:!0})})}),a.each(b.getVarModif(),function(b,f){a.each(b.pos,function(a){e.push({pos:g(a)+d.startPos,modifName:f,text:f,isTarget:f===c,isVar:!0})})}),{category:"psmIsoModifs",categoryName:"",type:"psmIsoModif",start:d.startPos-1,end:d.endPos-1,data:b,modif:e}})}).flatten().value();return d},f.prototype.getFeaturesPTMsCount=function(){var b=this;return a.map(b.protMatch.getAminoAcidInfo(),function(a){return{groupSet:a.searchId,category:"ptmCounts",categoryName:"",type:"ptmCount",start:a.pos-1,end:a.pos-1,data:a}})},f.prototype.getFeaturesAAInfos=function(){var b=this;return a.map(b.protMatch.getAminoAcidInfo(),function(a){return{groupSet:a.searchId,category:"aaInfos",categoryName:"",type:"aaInfo",start:a.pos-1,end:a.pos-1,data:a}})},f.prototype.getFeaturesAATargetModif=function(){var b=this;return a.chain(b.protMatch.getTargetAminoAcidWithTargetModif()).uniq("pos").map(function(a){return{category:"aaModif",categoryName:"",type:"aaModif",start:a.pos-1,end:a.pos-1,text:a.aa+a.pos}}).value()},f.prototype.setSelPsmPos=function(a){var b=this;b._selPsmPos=a},f.prototype.removeSelPsm=function(a){var b=this;b.selPsms=b.selPsms.filter(function(b){return!(b.searchId===a.searchId&&b.spNr===a.spNr)})},f.prototype.addSelPsm=function(a){var b=this,c={searchId:a.searchId,spNr:a.spectrumId.id};b.selPsms.push(c)},f}]),angular.module("psm-service",["thirdparties","environment","fishtones-wrapper"]).service("psmService",["_","$http","EnvConfig","httpProxy","fishtonifyService",function(a,b,c,d,e){var f=function(){return this};return f.prototype.addFishtonesObjects=function(b){return a.each(b,function(a){a.ppmDiff=f.prototype.convertToPpm(a.pep.molMass,a.matchInfo.massDiff,a.matchInfo.chargeState,a.matchInfo.massDiffUnit),a.fishTones=e.buildRichSeq(a),a.fishTones.searchId=a.searchId}),b},f.prototype.convertToPpm=function(a,b,c,d){return"dalton"===d?b*c/a*1e6:b},f.prototype.findAllBySearchIdsAndProteinId=function(a,b){var c=this,e="/match/psms/"+a.join(",")+"/by-ac/"+b;return d.get(e).then(c.addFishtonesObjects)},f.prototype.findAllBySearchIdAndSpectrumId=function(a,b){var c=this,e="/match/psms/"+a+"/by-spectrum/"+b;return d.get(e).then(c.addFishtonesObjects)},f.prototype.findAllProteinRefsBySearchIds=function(a,b){var c="/match/proteins/"+a.join(",");return b&&(c+="?withModif="+b),d.get(c)},f.prototype.findAllModificationsBySearchIds=function(a){return d.get("/match/modifications/"+a.join(","))},new f}]),angular.module("pviz-custom-psm",["thirdparties","environment","fishtones-wrapper"]).service("pvizCustomPsm",["_","pviz",function(a,b){var c=.1,d=2;b.FeatureDisplayer.trackHeightPerCategoryType.psms=.5,b.FeatureDisplayer.trackHeightPerCategoryType.ptmCounts=c,b.FeatureDisplayer.trackHeightPerCategoryType.psmIsoModifs=c,b.FeatureDisplayer.trackHeightPerCategoryType.aaInfos=c,b.FeatureDisplayer.setCustomHandler("psm",{appender:function(b,c,d,e){var f=c.selectAll("g.feature.internal.data."+e).data(d).enter().append("g").attr("class","feature internal data "+e);return f.append("line").attr({"class":function(a){return a.isSelected?"selected":""}}),f.append("text").text(function(a){return a.isSelected===!0?a.data.spectrumId.id:""}),f.selectAll("circle").data(function(b){return a.filter(b.modif,function(a){return a.selectedModif})}).enter().append("circle").attr({r:2,"class":function(a){return"first"===a.modifRank?"is-first":"firstWithConflict"===a.modifRank?"is-firstWithConflict":""}}),f.selectAll("rect").data(function(b){return a.filter(b.modif,function(a){return a.selectedModif===!1})}).enter().append("rect").attr({width:4,height:1,"class":function(a){return"first"===a.modifRank?"is-non-selected-modif":""}}),f},positioner:function(a,b){return b.attr("transform",function(b){return"translate(0,"+.5*a.scales.y(.5+b.displayTrack)+")"}),b.selectAll("line").attr("x1",function(b){return a.scales.x(b.start-.4)+1}).attr("x2",function(b){return a.scales.x(b.end+.4)}),b.selectAll("text").attr("x",function(b){return a.scales.x(b.end+2.4)}),b.selectAll("circle").attr("cx",function(b){return a.scales.x(b.pos)}),b.selectAll("rect").attr("x",function(b){return a.scales.x(b.pos)}),b}}),b.FeatureDisplayer.setCustomHandler("psmIsoModif",{appender:function(b,c,d,e){var f=c.selectAll("g.feature.internal.data."+e).data(d).enter().append("g").attr("class","feature internal data "+e);return f.append("line"),f.selectAll("circle").data(function(b){return a.filter(b.modif,function(a){return a.isFix})}).enter().append("circle").attr({r:2,"class":function(a){return a.isTarget?"is-target":""}}),f.selectAll("path").data(function(b){return a.filter(b.modif,function(a){return a.isVar})}).enter().append("g").attr("class","fixModif").append("path").attr({d:"M0,-3,L3,3,L-3,3L0,-3","class":function(a){return a.isTarget?"is-target":""}}),f},positioner:function(a,b){return b.attr("transform",function(b){return"translate(0,"+.4*a.scales.y(.5+b.displayTrack)+")"}),b.selectAll("line").attr("x1",function(b){return a.scales.x(b.start-.4)+1}).attr("x2",function(b){return a.scales.x(b.end+.4)}),b.selectAll("circle").attr("cx",function(b){return a.scales.x(b.pos)}),b.selectAll("g.fixModif").attr("transform",function(b){return"translate("+a.scales.x(b.pos)+",0)"}),b}}),b.FeatureDisplayer.setCustomHandler("ptmCount",{appender:function(a,b,c,d){var e=b.selectAll("g.feature.internal.data."+d).data(c).enter().append("g").attr("class","feature internal data "+d);return e.append("line").style("stroke-width",function(a){var b=a.data.depth;return b<=2?b:b<=9?b/2+1:b/4+3.5}),e.filter(function(a){return a.data.nbTargetModification}).classed("has-target-modif",!0).append("circle").attr("r",function(a){var b=a.data.nbTargetModification;return 1===b?2:b>=10?15:1.5*b}),e},positioner:function(a,b){return b.attr("transform",function(b){return"translate(0,"+.4*a.scales.y(.5+b.displayTrack)+")"}),b.selectAll("line").attr("x1",function(b){return a.scales.x(b.start-.5)}).attr("x2",function(b){return a.scales.x(b.end+.5)}),b.selectAll("circle").attr("cx",function(b){return a.scales.x(b.start)}),b}}),b.FeatureDisplayer.setCustomHandler("aaInfo",{appender:function(a,b,c,e){var f=b.selectAll("g.feature.internal.data."+e).data(c).enter().append("g").attr("class","feature internal data "+e);return f.append("line").style("stroke-width",function(a){var b=a.data.depth;return b/2+d}),f.filter(function(a){return a.data.nbTargetModification}).classed("has-target-modif",!0).append("circle").attr("r",5),f},positioner:function(a,b){return b.attr("transform",function(b){return"translate(0,"+.4*a.scales.y(.5+b.displayTrack)+")"}),b.selectAll("line").attr("x1",function(b){return a.scales.x(b.start-.5)}).attr("x2",function(b){return a.scales.x(b.end+.5)}),b}}),b.FeatureDisplayer.setCustomHandler("aaModif",{appender:function(a,b,c,d){var e=b.selectAll("g.feature.internal.data."+d).data(c).enter().append("g").attr({"class":"feature internal data "+d}).style("transform","rotate(-90deg)");return e.append("text").text(function(a){return a.text}).attr("x",-a.scales.y(.9)),e},positioner:function(a,b){return b.selectAll("text").attr("y",function(b){return a.scales.x(b.start)}),b}})}]),angular.module("xic",["thirdparties","environment","fishtones-wrapper","experimental","psm-service","matches-protein","table-expand-service"]).controller("XicController",function(){}).directive("xicPopover",function(){function a(a){var b="#xicPopover-"+a.myId;angular.element(b).popover(),a.$on("show-prec-info",function(c,d){a.popoverPsm=d,a.$apply(),angular.element(b).show();var e=a.$parent.coordinates[0],f=a.$parent.coordinates[1];angular.element(b).css("left",e-280+"px"),angular.element(b).css("top",f-20+"px")}),a.$on("hide-prec-info",function(a){angular.element(b).hide()})}return{restrict:"E",templateUrl:"scripts/main/compare/protein/xic/xic-popover.html",scope:{myId:"@myId"},link:a}}).directive("xicTable",["TableExpandedService",function(a){var b=function(b){b.tableExpanded=!1;var c=function(a){b.tableExpanded=a};a.notifyOnChange(b.item.id,c)};return{templateUrl:"scripts/main/compare/protein/basket/xic-table.html",restrict:"E",scope:!1,link:b}}]).directive("xicFishtones",["toaster","pviz","_","httpProxy","$q","fishtones","fishtonifyService","spectrumService","psmService","psmConvertionService",function(a,b,c,d,e,f,g,h,i,j){var k=function(b,k){var l=function(a,d,e,f){var g=c.find(b.$parent.selectedItems,function(a){return a.id===v}).id,h=m(k,a,b.searchIds,d,e,g,b,f);if(b.xicModel=h.model,b.$parent.selectedItems){var i=c.findWhere(b.$parent.selectedItems,{id:h.localId});i.xicView=h}return b.xicModel.on("change",function(){var a=c.map(b.xicModel.models,function(a){return a.get("selected")?{searchId:a.get("name"),rt:(a.get("selected")[0]/60).toFixed(2),"int":a.get("selected")[1].toExponential(2)}:{searchId:a.get("name")}});b.xicPeaks=a,b.item.xicPeaks=a,b.$apply()}),h},m=function(a,b,d,e,k,l,m,n){var o=l,p=new f.wet.Injection,q=new f.wet.XICCollection,r=function(a){return a.attributes.name},s=new f.wet.XICMultiPaneView({mousemoveCallback:function(a){m.$parent.coordinates=a},model:q,el:a,groupBy:r,orderBy:d}),t=s.yo;t++;for(var u=function(a){var b=a.precursor,d="scan: "+a.scanNumber+" ("+(b.retentionTime/60).toFixed(1)+"min) ",k={title:""},l=" ("+b.charge+"+)";if(a.psm){var o=a.psm.matchInfo.correctedMoz?a.psm.matchInfo.correctedMoz:b.moz;d+="m/z: "+o.toFixed(4)+l;var p=g.buildRichSeq(a.psm);a.psm.fishTones=p,k.prevAA=c.first(a.psm.proteinList).previousAA.toString(),k.nxtAA=c.first(a.psm.proteinList).nextAA.toString(),k.richSeq=p.richSeq.toString(),k.mainScore=a.psm.matchInfo.score.mainScore,k.isRejected=a.psm.matchInfo.isRejected,k.localisationScore=j.posScoreFromMatchInfo(a.psm.matchInfo,1);var q=c.map(a.psm.proteinList,function(a){return a.proteinRef.AC});k.AC=q.join();var r=i.convertToPpm(a.psm.pep.molMass,a.psm.matchInfo.massDiff,a.psm.matchInfo.chargeState,a.psm.matchInfo.massDiffUnit);d=d+" massDiff: "+r.toFixed(2)+" ppm"}else d+="m/z: "+b.moz.toFixed(4)+l;return k.title=d,new f.match.PrecursorPeak({retentionTime:a.precursor.retentionTime,isSource:a.precursor.retentionTime===e,sameChargeAsSource:a.precursor.charge===n,isIdentified:!!k.richSeq,onclickCallback:function(){h.findSpByRunIdAndId(a.spectrumId.runId,a.spectrumId.id).then(function(b){var d=a.psm&&a.psm.matchInfo.correctedMoz?a.psm.matchInfo.correctedMoz:b.ref.precursor.moz,e=g.convertSpectrum(b,d);if(a.psm)a.psm.fishTones.spectrum=e,a.psm.matchInfo.posScore=j.posScoreFromMatchInfo(a.psm.matchInfo,1),a.psm.prevAA=c.first(a.psm.proteinList).previousAA.toString(),a.psm.nxtAA=c.first(a.psm.proteinList).nextAA.toString(),a.psm.ppmDiff=i.convertToPpm(a.psm.pep.molMass,a.psm.matchInfo.massDiff,a.psm.matchInfo.chargeState,a.psm.matchInfo.massDiffUnit),m.$emit("basket-add",{type:"psm",bean:a.psm});else{var f=b.ref;f.spectrum=e,m.$emit("basket-add",{type:"sp",bean:f})}var h={id:b.ref.spectrumId.id};m.$emit("psm-selected",{searchId:b.ref.spectrumId.runId,spectrumId:h})})},mouseoutCallback:function(){m.$broadcast("hide-prec-info",null)},mouseoverCallback:function(){m.$broadcast("show-prec-info",k)}})},v=0;v<b.length;v++){var w=b[v],x=w.ms2,y=c.map(x,u),z=new f.wet.XIC;z.set({retentionTimes:w.rt}),z.set({intensities:w.intensities}),z.set({injection:p}),z.set({name:d[v]}),z.set({target:0}),z.set({precursors:y}),d[v]===k&&z.set({selectedRt:e}),q.add(z)}return s.localId=o,s},n=function(a,b,c){var e="/exp/xic/"+a+"/"+b+"?tolerance="+c+"&rtTolerance=10.0";return d.get(e)},o=function(a,b,c,e){var f=c?"by-mass/"+b+"/"+c:b,g="/exp/spectra-ref/"+a+"/"+f+"?tolerance="+e;return d.get(g)},p=function(a,b){var c="/match/psms/"+a+"/by-spectrum/"+b;return d.get(c)},q=function(b,c){var d=[],f=[];b.forEach(function(a){d.push(n(a,u.precMoz,u.xicTolerance)),f.push(o(a,u.precMoz,u.precCharge,u.xicTolerance))}),e.all(d.concat(f)).then(function(b){var d=r(b);s(d),a.clear(c)})},r=function(a){for(var b=a.length/2,c=a.slice(0,b),d=a.slice(b),e=[],f=0;f<c.length;f++)e[f]=c[f],e[f].ms2=d[f];return e},s=function(a){for(var b=[],c=0;c<a.length;c++)for(var d=a[c].ms2,f=0;f<d.length;f++){var g=d[f];b.push(p(g.spectrumId.runId,g.spectrumId.id))}e.all(b).then(function(b){var c=t(a,b);l(c,u.retentionTime,u.searchId,u.precCharge,u.scanNr,v)})},t=function(a,b){for(var d=0,e=0;e<a.length;e++)for(var f=a[e],g=0;g<f.ms2.length;g++){var h=b[d],i=c.filter(h,function(a){return 1===a.matchInfo.rank});a[e].ms2[g].psm=i[0],d++}return a},u=b.item.ms2Info,v=b.item.id,w=a.pop("wait","Loading XIC","",0);q(b.searchIds,w)};return{link:k,restrict:"A"}}]),angular.module("spectrum-tab",["thirdparties","environment","matches-basket","psm-service","searches-list","matches-protein"]).controller("DetailsTabCtrl",["$scope","$q","_","psmService","spectrumService","fishtones","fishtonifyService","pviz","$routeParams","searchService","psmConvertionService",function(a,b,c,d,e,f,g,h,i,j,k){a.searchIds=i.searchIds.split(",");var l=i.runId,m=i.spectrumId;a.spectra=[],d.findAllBySearchIdAndSpectrumId(l,m).then(function(a){n(a)});var n=function(b){var d;b.length>=1&&(d=b[0],d=c.find(b,function(a){return 1===a.matchInfo.rank}),d.matchInfo.posScore=k.posScoreFromMatchInfo(d.matchInfo,1)),e.findSpByRunIdAndId(l,m).then(function(b){var c,e=d&&d.matchInfo.correctedMoz?d.matchInfo.correctedMoz:b.ref.precursor.moz,h=g.convertSpectrum(b,e),i={precCharge:b.ref.precursor.charge,precIntensity:b.ref.precursor.intensity,precMoz:e,retentionTime:b.ref.precursor.retentionTime,searchId:l,scanNr:m};d?(d.fishTones=g.buildRichSeq(d),d.fishTones.spectrum=h,d.fishTones.theoMoz=f.dry.MassBuilder.computeMassRichSequence(d.fishTones.richSeq),c={type:"psm",firstPsm:d,otherPsms:[],ms2Info:i},j.get(c.firstPsm.searchId).then(function(b){var d=b.fragmentTolerance.split(/\s+/);switch(c.firstPsm.fishTones.fragmentTolerance=d[0],d[1].charAt(0).toLowerCase()){case"p":c.firstPsm.fishTones.fragmentToleranceUnit="ppm";break;case"d":c.firstPsm.fishTones.fragmentToleranceUnit="dalton";break;default:c.firstPsm.fishTones.fragmentToleranceUnit=void 0}a.spectra.push(c)})):(c={type:"sp",ms2Info:i,firstPsm:{fishTones:{spectrum:h}}},a.spectra.push(c))})}}]),angular.module("results-services",["thirdparties","environment"]).service("resultsService",["httpProxy",function(a){var b=function(){return this};return b.prototype.list=function(){return a.get("/basket")},b.prototype.deleteEntry=function(b){return a["delete"]("/basket/by-mongo/"+b.$oid)},b.prototype.deleteBySearchIds=function(b){return a["delete"]("/basket/"+b)},b.prototype.findBySearchId=function(b){return a.get("/basket/"+b)},b.prototype.findBySearchIdTsv=function(b){return a.get("/basket/"+b,{headers:{Accept:"application/tsv"}})},new b}]),angular.module("results-controller",["thirdparties","environment"]).controller("ResultsCtrl",["$scope","resultsService",function(a,b){a.listBaskets=function(){b.list().then(function(b){var c=_.map(b,function(a){var b=a.lastModif?new Date(a.lastModif):null,c=a.firstModif?new Date(a.firstModif):null,d=a.lastModif?a.lastModif:0;return{searchId:a._id,lastModif:b,firstModif:c,rawLastModif:d}});a.resultList=c})},a.deleteBySearchIds=function(c){b.deleteBySearchIds(c).then(function(){a.listBaskets()})},a.listBaskets()}]).controller("OneResultCtrl",["$scope","$routeParams","resultsService","_",function(a,b,c,d){a.searchId=b.searchId,a.searchIds=a.searchId.split(","),a.rts=d.map(a.searchIds,function(a){return"rt "+a}),a.ints=d.map(a.searchIds,function(a){return"int "+a}),c.findBySearchId(a.searchId).then(function(b){a.entries=b}),a.deleteEntry=function(b){c.deleteEntry(b).then(function(){c.findBySearchId(a.searchId).then(function(b){a.entries=b})})},a.downloadTsv=function(){c.findBySearchIdTsv(a.searchId).then(function(a){var b=angular.element("<a/>");b.css({display:"none"}),angular.element(document.body).append(b),b.attr({href:"data:attachment/csv;charset=utf-8,"+encodeURI(a),target:"_blank",download:"results.csv"})[0].click()})}}]),angular.module("databases-services",["thirdparties","environment"]).service("databasesService",["httpProxy",function(a){var b=function(){return this};return b.prototype.listFasta=function(){return a.get("/sequences/list-sources")},b.prototype.addFasta=function(b){return a.post("/sequences/"+b+"/fasta")},b.prototype.deleteFasta=function(b){return a["delete"]("/sequences/"+b)},new b}]),angular.module("databases-controller",["toaster","thirdparties","environment","ngFileUpload","databases-services"]).directive("ngFiles",["$parse",function(a){function b(b,c,d){var e=a(d.ngFiles);c.on("change",function(a){e(b,{$files:a.target.files})})}return{link:b}}]).controller("DatabasesCtrl",["toaster","$scope","databasesService","$http","EnvConfig",function(a,b,c,d,e){setTimeout(function(){b.toast=a.pop("wait","Loading databases","",0),console.log(b.toast)},10),b.hideProgressBar=!0,b.parsingRule={activated:!1,value:void 0,style:{color:"lightgrey"}},b.parsingRuleSelected=void 0,b.parsingRuleDefaults=[{name:"SwissProt_ID",regexp:">..\\|[^|]*\\|([^ ]*)"},{name:"SwissProt_AC",regexp:">..\\|([^|]*)"},{name:"Trembl",regexp:">..\\|[^|]*\\|([^ ]*)"},{name:"custom",regexp:">([^ ]*)"}],b.changeParsingRuleStyle=function(){b.parsingRule.style.color=b.parsingRule.activated?"black":"lightgrey"},setTimeout(function(){c.listFasta().then(function(c){b.databasesList=c,a.clear(b.toast)})},20),b.deleteEntry=function(a){c.deleteFasta(a).then(function(){c.listFasta().then(function(a){b.databasesList=a})})};var f=new FormData;b.getTheFiles=function(a){f=a[0]},b.uploadFiles=function(){if(b.databaseUploadError=!1,b.hideProgressBar=!1,void 0===b.databasesList||b.databasesList.indexOf(f.name)<0){var a=b.parsingRule.activated?"?regexp="+b.parsingRuleSelected:"",g={method:"POST",url:e.backendUrl+"/sequences/"+f.name+"/fasta"+a,data:f,headers:{"Content-Type":void 0}};d(g).success(function(){b.hideProgressBar=!0,b.databaseUploaded=f.name,c.listFasta().then(function(a){b.databasesList=a})}).error(function(){b.hideProgressBar=!0,b.databaseUploaded=!1,b.databaseUploadError=!0,c.listFasta().then(function(a){b.databasesList=a})})}else b.databaseFound=f.name,b.$apply()}}]),angular.module("uploads-controller",["thirdparties","environment","ngFileUpload"]).directive("ngFiles",["$parse",function(a){function b(b,c,d){var e=a(d.ngFiles);c.on("change",function(a){e(b,{$files:a.target.files})})}return{link:b}}]).controller("UploadsCtrl",["$scope","$http","EnvConfig",function(a,b,c){a.intThreshold={activated:!1,value:1e4,style:{color:"lightgrey"}},a.changeIntThresholdStyle=function(){a.intThreshold.style.color=a.intThreshold.activated?"black":"lightgrey"},a.hideProgressBar=!0,a.fileType="mascot";var d=new FormData;a.getTheFiles=function(a){d=a[0]},a.uploadFiles=function(){a.hideProgressBar=!1;var e=a.intThreshold.activated?a.intThreshold.value:1,f={method:"POST",url:c.backendUrl+"/uploads/"+a.fileType+"?intensityThr="+e,data:d,headers:{"Content-Type":void 0}};b(f).success(function(){a.fileUploaded="upload",a.hideProgressBar=!0}).error(function(){a.fileFailed="error",a.hideProgressBar=!0})}}]),angular.module("about-msviz",["environment"]).controller("AboutCtrl",["httpProxy","$scope",function(a,b){b.frontendVersion="1.0.14",a.get("/version").then(function(a){b.backendVersion=a})}]);